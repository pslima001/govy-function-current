<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOVY | KB Content Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f4f5f7;
            --bg-card: #ffffff;
            --bg-input: #f8f9fb;
            --border: #e2e5ea;
            --border-focus: #b8941e;
            --text-primary: #1a2332;
            --text-secondary: #4a5568;
            --text-muted: #8896a6;
            --gold-600: #9a7b1a;
            --gold-500: #b8941e;
            --gold-400: #c9a227;
            --green-600: #059669;
            --green-500: #10b981;
            --red-600: #dc2626;
            --red-500: #ef4444;
            --amber-500: #d97706;
            --blue-500: #2563eb;
            --radius: 10px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* === HEADER === */
        .header {
            background: #ffffff;
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .header-brand { display: flex; align-items: center; gap: 14px; }
        .header-logo {
            font-family: 'DM Serif Display', serif;
            font-size: 50px; color: var(--gold-500); letter-spacing: 2px;
        }
        .header-sub {
            font-size: 24px; color: var(--text-muted);
            border-left: 1px solid var(--border); padding-left: 14px; font-weight: 300;
        }
        .header-status { display: flex; align-items: center; gap: 8px; font-size: 22px; color: var(--text-muted); }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--green-500); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

        /* === TABS === */
        .tabs {
            display: flex; gap: 0; padding: 0 32px;
            background: #ffffff;
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            padding: 14px 24px; background: none; border: none;
            color: var(--text-muted); font-family: 'DM Sans', sans-serif;
            font-size: 25px; font-weight: 500; cursor: pointer;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--gold-500); }
        .tab-btn.active { color: var(--gold-600); border-bottom-color: var(--gold-500); font-weight: 600; }

        /* === MAIN === */
        .main { padding: 24px 32px; margin: 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* === CARDS === */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px; margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .card h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 36px; color: var(--gold-600);
            margin-bottom: 16px; font-weight: 400;
        }

        /* === FORM === */
        textarea, input, select {
            width: 100%; padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary);
            font-family: 'DM Sans', sans-serif; font-size: 25px;
            transition: border-color 0.2s;
        }
        textarea:focus, input:focus, select:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(184,148,30,0.1); }
        textarea { resize: vertical; min-height: 200px; line-height: 1.6; }
        select { cursor: pointer; appearance: auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; font-size: 22px; font-weight: 600;
            color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px;
        }

        /* === BUTTONS === */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-family: 'DM Sans', sans-serif; font-size: 25px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-400));
            color: #ffffff;
        }
        .btn-gold:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(184,148,30,0.3); }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .btn-outline:hover:not(:disabled) { border-color: var(--gold-500); color: var(--gold-600); }
        .btn-sm { padding: 6px 14px; font-size: 22px; }
        .btn-green { background: var(--green-600); color: white; }
        .btn-green:hover:not(:disabled) { background: var(--green-500); }
        .btn-red { background: var(--red-600); color: white; }
        .btn-red:hover:not(:disabled) { background: var(--red-500); }

        /* === FILTERS === */
        .filters { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .filters select { width: auto; min-width: 180px; }

        /* === STATS === */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px; text-align: center;
            box-shadow: var(--shadow);
        }
        .stat-value { font-family: 'DM Serif Display', serif; font-size: 66px; color: var(--gold-600); }
        .stat-label { font-size: 22px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

        /* === TABLE === */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th {
            text-align: left; padding: 12px 16px; font-size: 20px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--text-muted); border-bottom: 2px solid var(--border); white-space: nowrap;
        }
        tbody td {
            padding: 14px 16px; font-size: 25px;
            border-bottom: 1px solid #f0f1f3; vertical-align: top;
        }
        tbody tr:hover { background: #faf8f0; }

        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .badge-deleted { background: #f3f4f6; color: #6b7280; }

        .source-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 20px; font-weight: 700; }
        .source-tcu { background: #dbeafe; color: #1e40af; }
        .source-tce { background: #d1fae5; color: #065f46; }
        .source-other { background: #f3f4f6; color: #6b7280; }

        .text-preview {
            max-width: 400px; font-size: 24px; color: var(--text-secondary);
            line-height: 1.5; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .actions { display: flex; gap: 6px; white-space: nowrap; }

        /* === LOG === */
        .log-box {
            background: #fafbfc; border: 1px solid var(--border);
            border-radius: 8px; padding: 16px;
            font-family: 'Courier New', monospace; font-size: 24px;
            line-height: 1.8; max-height: 300px; overflow-y: auto; color: var(--text-secondary);
        }
        .log-ok { color: var(--green-600); }
        .log-err { color: var(--red-600); }
        .log-info { color: var(--blue-500); }
        .log-warn { color: var(--amber-500); }

        /* === DETECTION === */
        .detection-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px; margin-top: 12px;
        }
        .det-item { background: #f8f9fb; border: 1px solid #eef0f3; border-radius: 8px; padding: 12px; }
        .det-label { font-size: 20px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .det-value { font-size: 29px; color: var(--gold-600); font-weight: 600; margin-top: 4px; }

        /* === MODAL === */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.35); backdrop-filter: blur(4px);
            z-index: 200; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius); padding: 32px;
            width: 90%; max-width: 520px;
            box-shadow: var(--shadow-lg);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-box h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 41px; color: var(--gold-600); margin-bottom: 16px;
        }
        .modal-actions {
            display: flex; justify-content: flex-start;
            gap: 10px; margin-top: 20px;
        }

        /* === TOAST === */
        .toast-container {
            position: fixed; top: 80px; right: 24px; z-index: 300;
            display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
            padding: 14px 20px; border-radius: 8px; font-size: 25px; font-weight: 500;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 3.5s forwards;
            max-width: 400px; box-shadow: var(--shadow-lg);
        }
        .toast-success { background: var(--green-600); color: white; }
        .toast-error { background: var(--red-600); color: white; }
        .toast-info { background: #ffffff; color: var(--text-primary); border: 1px solid var(--gold-500); }
        @keyframes slideIn { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
        @keyframes fadeOut { to{opacity:0;transform:translateY(-10px);} }

        /* === LOADING === */
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner {
            display: inline-block; width: 32px; height: 32px;
            border: 3px solid #e8e5d8; border-top-color: var(--gold-500);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to{transform:rotate(360deg);} }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 87px; margin-bottom: 12px; opacity: 0.4; }

        /* === KEYBOARD NAV HINTS === */
        .kbd {
            display: inline-block; padding: 2px 6px; background: #f0f1f3;
            border: 1px solid #d4d6db; border-radius: 4px;
            font-family: 'Courier New', monospace; font-size: 20px; color: var(--text-muted);
        }
        .nav-hint { font-size: 20px; color: var(--text-muted); margin-left: 8px; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .main { padding: 16px; }
            .tabs { padding: 0 16px; }
            .form-row { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .filters { flex-direction: column; }
            .filters select { width: 100%; }
            .nav-hint { display: none; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-brand">
        <div class="header-logo">GOVY</div>
        <div class="header-sub">KB Content Hub v2.4</div>
    </div>
    <div class="header-status">
        <div class="status-dot"></div>
        <span id="connStatus">Conectado</span>
    </div>
</div>

<!-- TABS -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('paste')">Colar Texto <span class="nav-hint"><span class="kbd">Alt+1</span></span></button>
    <button class="tab-btn" onclick="switchTab('manage')">Gerenciar <span class="nav-hint"><span class="kbd">Alt+2</span></span></button>
    <button class="tab-btn" onclick="switchTab('search')">Buscar KB <span class="nav-hint"><span class="kbd">Alt+3</span></span></button>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- REJECT MODAL -->
<div class="modal-overlay" id="rejectModal">
    <div class="modal-box">
        <h3>Rejeitar Documento</h3>
        <div class="form-group">
            <label>Motivo da rejeicao</label>
            <textarea id="rejectReason" rows="3" placeholder="Informe o motivo..."></textarea>
        </div>
        <input type="hidden" id="rejectDocId">
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeRejectModal()">Cancelar</button>
            <button class="btn btn-red" onclick="confirmReject()">Rejeitar</button>
        </div>
    </div>
</div>

<!-- DETAIL / REVIEW MODAL -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-box" style="max-width:780px;">
        <h3 id="detailTitle">Detalhes</h3>
        <div id="detailBody" style="max-height:500px; overflow-y:auto; margin-bottom:16px;"></div>
        <div class="modal-actions" id="detailActions">
            <button class="btn btn-outline" onclick="closeDetailModal()">Fechar</button>
        </div>
    </div>
</div>

<div class="main">

    <!-- ==================== TAB: PASTE ==================== -->
    <div id="tab-paste" class="tab-content active">
        <div class="card">
            <h2>Colar Jurisprudencia</h2>
            <div class="form-group">
                <label>Texto da jurisprudencia (minimo 100 caracteres)</label>
                <textarea id="pasteText" placeholder="Cole aqui o texto do acordao, decisao ou sumula..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Criado por</label>
                    <input type="text" id="pasteAuthor" placeholder="Seu nome" value="Paulo">
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-gold" id="btnPaste" onclick="submitPaste()">Enviar para Curadoria</button>
                </div>
            </div>
        </div>

        <!-- Detection Result -->
        <div class="card" id="detectionCard" style="display:none;">
            <h2>Resultado da Deteccao</h2>
            <div class="detection-grid" id="detectionGrid"></div>
        </div>

        <!-- Log -->
        <div class="card">
            <h2>Log de Atividade</h2>
            <div class="log-box" id="pasteLog">Aguardando acao...</div>
        </div>
    </div>

    <!-- ==================== TAB: MANAGE ==================== -->
    <div id="tab-manage" class="tab-content">
        <!-- Stats -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statApproved">-</div>
                <div class="stat-label">Aprovados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statRejected">-</div>
                <div class="stat-label">Rejeitados</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card">
            <h2>Filtros</h2>
            <div class="filters">
                <select id="filterStatus" onchange="loadContent()">
                    <option value="">Todos os status</option>
                    <option value="PENDING_REVIEW">Pendente Revisao</option>
                    <option value="APPROVED">Aprovado</option>
                    <option value="REJECTED">Rejeitado</option>
                </select>
                <select id="filterLimit">
                    <option value="20">20 itens</option>
                    <option value="50" selected>50 itens</option>
                    <option value="100">100 itens</option>
                </select>
                <button class="btn btn-gold" onclick="loadContent()">Atualizar</button>
            </div>
        </div>

        <!-- Content Table -->
        <div class="card">
            <h2>Conteudo <span id="contentCount" style="font-family:'DM Sans';font-size: 25px;color:var(--text-muted);font-weight:400;"></span></h2>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Acoes</th>
                            <th>Tribunal</th>
                            <th>Titulo / Citacao</th>
                            <th>Preview</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="contentBody">
                        <tr><td colspan="6" class="loading"><div class="spinner"></div><br>Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== TAB: SEARCH ==================== -->
    <div id="tab-search" class="tab-content">
        <div class="card">
            <h2>Buscar na Knowledge Base</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Consulta</label>
                    <input type="text" id="searchQuery" placeholder="Ex: prazo entrega licitacao pregao" onkeydown="if(event.key==='Enter')searchKB()">
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end; gap:8px;">
                    <select id="searchTop" style="width:auto; min-width:80px;">
                        <option value="3">Top 3</option>
                        <option value="5" selected>Top 5</option>
                        <option value="10">Top 10</option>
                    </select>
                    <button class="btn btn-gold" onclick="searchKB()">Buscar</button>
                </div>
            </div>
        </div>
        <div id="searchResults"></div>
    </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
var API_URL = 'https://func-govy-parse-test-exabasfqgsfgexhd.eastus-01.azurewebsites.net';
var API_KEY = '<AZURE_FUNCTION_KEY>';

// ============================================================
// HELPERS
// ============================================================
function apiUrl(path) {
    var sep = path.indexOf('?') >= 0 ? '&' : '?';
    return API_URL + path + sep + 'code=' + API_KEY;
}

function showToast(msg, type) {
    type = type || 'info';
    var el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    document.getElementById('toastContainer').appendChild(el);
    setTimeout(function() { el.remove(); }, 4000);
}

function log(msg, cls) {
    cls = cls || '';
    var box = document.getElementById('pasteLog');
    var ts = new Date().toLocaleTimeString('pt-BR');
    box.innerHTML += '<div class="log-entry ' + cls + '">[' + ts + '] ' + msg + '</div>';
    box.scrollTop = box.scrollHeight;
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(str) {
    if (!str) return '-';
    try {
        var d = new Date(str);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
    } catch(e) { return str; }
}

function statusBadge(status) {
    var map = {
        'PENDING_REVIEW': 'badge-pending',
        'APPROVED': 'badge-approved',
        'REJECTED': 'badge-rejected',
        'DELETED': 'badge-deleted'
    };
    var cls = map[status] || 'badge-pending';
    var labels = {
        'PENDING_REVIEW': 'Pendente',
        'APPROVED': 'Aprovado',
        'REJECTED': 'Rejeitado',
        'DELETED': 'Excluido'
    };
    var lbl = labels[status] || status;
    return '<span class="badge ' + cls + '">' + lbl + '</span>';
}

function sourceBadge(source) {
    if (!source) return '<span class="source-badge source-other">N/A</span>';
    var s = source.toUpperCase();
    if (s.indexOf('TCU') >= 0) return '<span class="source-badge source-tcu">TCU</span>';
    if (s.indexOf('TCE') >= 0) return '<span class="source-badge source-tce">TCE</span>';
    return '<span class="source-badge source-other">' + escapeHtml(source) + '</span>';
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(function(b, i) {
        b.classList.remove('active');
        if ((tab === 'paste' && i === 0) || (tab === 'manage' && i === 1) || (tab === 'search' && i === 2)) {
            b.classList.add('active');
        }
    });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('tab-' + tab).classList.add('active');
    
    if (tab === 'manage') {
        loadContent();
        loadStats();
    }
}

// ============================================================
// PASTE SUBMISSION
// ============================================================
function submitPaste() {
    var text = document.getElementById('pasteText').value.trim();
    var author = document.getElementById('pasteAuthor').value.trim() || 'anonimo';
    
    if (text.length < 100) {
        showToast('Texto deve ter no minimo 100 caracteres (atual: ' + text.length + ')', 'error');
        return;
    }
    
    var btn = document.getElementById('btnPaste');
    btn.disabled = true;
    btn.textContent = 'Enviando...';
    log('Enviando texto (' + text.length + ' chars)...', 'log-info');
    
    var body = JSON.stringify({ text: text, created_by: author });
    
    fetch(apiUrl('/api/kb/juris/paste'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: body
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'Enviar para Curadoria';
        
        if (data.status === 'duplicate') {
            log('DUPLICATA detectada - SHA: ' + (data.source_sha || '').substring(0, 12) + '...', 'log-warn');
            showToast('Documento duplicado! Ja existe no sistema.', 'error');
            return;
        }
        
        if (data.status === 'error') {
            log('ERRO: ' + (data.error || data.message || 'desconhecido'), 'log-err');
            showToast('Erro: ' + (data.error || data.message || 'desconhecido'), 'error');
            return;
        }
        
        // Success
        log('SUCESSO - Status: ' + data.status, 'log-ok');
        log('SHA: ' + (data.source_sha || 'N/A'), 'log-ok');
        showToast('Documento enviado com sucesso!', 'success');
        
        // Show detection results
        var det = data.detected;
        if (det) {
            var card = document.getElementById('detectionCard');
            card.style.display = 'block';
            var grid = document.getElementById('detectionGrid');
            grid.innerHTML = '';
            
            var fields = [
                { label: 'Tribunal', value: det.tribunal || det.tribunal_family || 'N/A' },
                { label: 'Caso', value: det.case_number_primary || 'N/A' },
                { label: 'Ano', value: det.year || 'N/A' },
                { label: 'UF', value: det.uf || 'Nacional' },
                { label: 'Confianca', value: det.confidence ? (det.confidence * 100).toFixed(0) + '%' : 'N/A' },
                { label: 'Status', value: data.status || 'N/A' }
            ];
            
            fields.forEach(function(f) {
                grid.innerHTML += '<div class="det-item"><div class="det-label">' + f.label + '</div><div class="det-value">' + f.value + '</div></div>';
            });
            
            log('Tribunal: ' + (det.tribunal || 'N/A') + ' | Caso: ' + (det.case_number_primary || 'N/A') + ' | Ano: ' + (det.year || 'N/A') + ' | Confianca: ' + (det.confidence || 'N/A'), 'log-info');
        }
        
        // Auto-approve info
        if (data.auto_approve_reason) {
            log('Auto-approve: ' + data.auto_approve_reason, 'log-warn');
        }
        
        document.getElementById('pasteText').value = '';
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'Enviar para Curadoria';
        log('ERRO de conexao: ' + err.message, 'log-err');
        showToast('Erro de conexao: ' + err.message, 'error');
    });
}

// ============================================================
// LOAD STATS - always from _allItems
// ============================================================
var _allItems = []; // master cache

function loadStats() {
    // Count from _allItems (already loaded)
    var counts = { total: _allItems.length, PENDING_REVIEW: 0, APPROVED: 0, REJECTED: 0 };
    _allItems.forEach(function(item) {
        var st = item.review_status || '';
        if (counts[st] !== undefined) counts[st]++;
    });
    document.getElementById('statTotal').textContent = counts.total;
    document.getElementById('statPending').textContent = counts.PENDING_REVIEW;
    document.getElementById('statApproved').textContent = counts.APPROVED;
    document.getElementById('statRejected').textContent = counts.REJECTED;
}

// ============================================================
// LOAD CONTENT LIST (single API call, stats derived from same data)
// ============================================================
function loadContent() {
    var statusFilter = document.getElementById('filterStatus').value;
    var limit = parseInt(document.getElementById('filterLimit').value) || 50;
    
    var tbody = document.getElementById('contentBody');
    tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div><br>Carregando...</td></tr>';
    
    // ALWAYS fetch ALL items (limit=500) to get accurate stats
    fetch(apiUrl('/api/kb/content/list?limit=500'))
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.status === 'error') {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">!</div><div class="empty-state-text">Erro: ' + escapeHtml(data.error || 'desconhecido') + '</div></td></tr>';
            return;
        }
        
        // Store ALL items and update stats
        _allItems = data.items || [];
        _itemsCache = _allItems;
        loadStats();
        
        // Client-side filter
        var filtered = _allItems;
        if (statusFilter) {
            filtered = _allItems.filter(function(item) {
                return item.review_status === statusFilter;
            });
        }
        
        // Apply limit
        var display = filtered.slice(0, limit);
        document.getElementById('contentCount').textContent = '(' + filtered.length + ' itens)';
        
        if (display.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">-</div><div class="empty-state-text">Nenhum item encontrado</div></td></tr>';
            return;
        }
        
        var html = '';
        display.forEach(function(item) {
            // CRITICAL: Backend returns "id", not "doc_id"
            var docId = item.id || item.doc_id || '';
            var reviewStatus = item.review_status || 'PENDING_REVIEW';
            var preview = item.text_preview || item.content || item.text || '';
            if (preview.length > 200) preview = preview.substring(0, 200) + '...';
            var createdAt = formatDate(item.created_at || item.detected_at);
            
            // Extract tribunal and build readable title
            var tribunal = '';
            var displayTitle = '';
            var displaySub = '';
            if (item.detected) {
                tribunal = item.detected.tribunal || item.detected.tribunal_family || '';
                var caseName = item.detected.case_number_primary || '';
                var year = item.detected.year || '';
                var citation = item.detected.citation || '';
                // Build title: "Tribunal - Caso/Ano" or citation
                if (tribunal && caseName) {
                    displayTitle = tribunal + ' - ' + caseName;
                } else if (citation) {
                    displayTitle = citation;
                } else if (tribunal && year) {
                    displayTitle = tribunal + ' ' + year;
                }
                displaySub = caseName || '';
            }
            if (!tribunal && item.source) tribunal = item.source;
            // Filter out blob paths from any title source
            function isBlob(s) { return s && (s.indexOf('jurisprudencia/') === 0 || s.indexOf('.json') !== -1 || s.indexOf('/') !== -1 && s.length > 40); }
            if (!displayTitle) {
                var candidates = [item.title, item.citation, item.detected ? item.detected.citation : ''];
                for (var ci = 0; ci < candidates.length; ci++) {
                    if (candidates[ci] && !isBlob(candidates[ci])) { displayTitle = candidates[ci]; break; }
                }
                if (!displayTitle && tribunal && year) displayTitle = tribunal + ' ' + year;
                if (!displayTitle && tribunal) displayTitle = tribunal;
                if (!displayTitle) displayTitle = 'Jurisprudencia';
            }
            
            html += '<tr>';
            html += '<td>' + statusBadge(reviewStatus) + '</td>';
            html += '<td>' + sourceBadge(tribunal) + '</td>';
            html += '<td style="max-width:260px;"><strong>' + escapeHtml(displayTitle.substring(0, 80)) + '</strong>';
            if (displaySub && displaySub !== displayTitle) html += '<br><span style="font-size: 22px;color:var(--text-secondary);">' + escapeHtml(displaySub) + '</span>';
            if (!displaySub && docId) html += '<br><span style="font-size: 20px;color:var(--text-muted);">' + escapeHtml(docId.substring(0, 16)) + '...</span>';
            html += '</td>';
            html += '<td><div class="text-preview">' + escapeHtml(preview) + '</div></td>';
            html += '<td style="white-space:nowrap;">' + createdAt + '</td>';
            html += '<td><div class="actions">';
            
            // PENDING: open review modal instead of simple approve
            if (reviewStatus === 'PENDING_REVIEW') {
                html += '<button class="btn btn-sm btn-green" onclick="viewDetail(\'' + docId + '\',true)">Revisar</button>';
                html += '<button class="btn btn-sm btn-red" onclick="openRejectModal(\'' + docId + '\')">Rejeitar</button>';
            }
            if (reviewStatus !== 'DELETED') {
                html += '<button class="btn btn-sm btn-outline" onclick="viewDetail(\'' + docId + '\',false)">Ver</button>';
                html += '<button class="btn btn-sm btn-outline" onclick="deleteDoc(\'' + docId + '\')">Excluir</button>';
            }
            
            html += '</div></td>';
            html += '</tr>';
        });
        
        tbody.innerHTML = html;
    })
    .catch(function(err) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">!</div><div class="empty-state-text">Erro de conexao: ' + escapeHtml(err.message) + '</div></td></tr>';
    });
}

// ============================================================
// APPROVE / REJECT / DELETE
// ============================================================
function approveDoc(docId) {
    if (!confirm('Aprovar este documento e indexar no Azure Search?')) return;
    
    showToast('Aprovando...', 'info');
    
    fetch(apiUrl('/api/kb/content/' + docId + '/approve'), { method: 'POST' })
    .then(function(r) {
        var httpOk = r.ok;
        return r.json().then(function(data) { return { httpOk: httpOk, data: data }; });
    })
    .then(function(result) {
        var data = result.data;
        console.log('Approve response:', JSON.stringify(data));
        // Accept success, approved, ok, or HTTP 200 with no error
        var isSuccess = data.status === 'success' || data.status === 'approved' || data.status === 'ok' || (result.httpOk && !data.error);
        if (isSuccess) {
            showToast('Documento aprovado e indexado!', 'success');
            loadContent();
            loadStats();
        } else {
            showToast('Erro ao aprovar: ' + (data.error || data.message || data.detail || JSON.stringify(data)), 'error');
        }
    })
    .catch(function(err) {
        showToast('Erro de conexao: ' + err.message, 'error');
    });
}

function openRejectModal(docId) {
    document.getElementById('rejectDocId').value = docId;
    document.getElementById('rejectReason').value = '';
    document.getElementById('rejectModal').classList.add('show');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.remove('show');
}

function confirmReject() {
    var docId = document.getElementById('rejectDocId').value;
    var reason = document.getElementById('rejectReason').value.trim();
    
    if (!reason) {
        showToast('Informe o motivo da rejeicao', 'error');
        return;
    }
    
    closeRejectModal();
    showToast('Rejeitando...', 'info');
    
    fetch(apiUrl('/api/kb/content/' + docId + '/reject'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: reason })
    })
    .then(function(r) {
        var httpOk = r.ok;
        return r.json().then(function(data) { return { httpOk: httpOk, data: data }; });
    })
    .then(function(result) {
        var data = result.data;
        var isSuccess = data.status === 'success' || data.status === 'rejected' || (result.httpOk && !data.error);
        if (isSuccess) {
            showToast('Documento rejeitado.', 'success');
            loadContent();
            loadStats();
        } else {
            showToast('Erro ao rejeitar: ' + (data.error || data.message || JSON.stringify(data)), 'error');
        }
    })
    .catch(function(err) {
        showToast('Erro de conexao: ' + err.message, 'error');
    });
}

function deleteDoc(docId) {
    if (!confirm('Excluir este documento? (soft delete)')) return;
    
    showToast('Excluindo...', 'info');
    
    fetch(apiUrl('/api/kb/content/' + docId + '/delete?mode=soft'), { method: 'POST' })
    .then(function(r) {
        var httpOk = r.ok;
        return r.json().then(function(data) { return { httpOk: httpOk, data: data }; });
    })
    .then(function(result) {
        var data = result.data;
        var isSuccess = data.status === 'success' || data.status === 'deleted' || (result.httpOk && !data.error);
        if (isSuccess) {
            showToast('Documento excluido.', 'success');
            loadContent();
            loadStats();
        } else {
            showToast('Erro ao excluir: ' + (data.error || data.message || JSON.stringify(data)), 'error');
        }
    })
    .catch(function(err) {
        showToast('Erro de conexao: ' + err.message, 'error');
    });
}

// ============================================================
// VIEW DETAIL / REVIEW MODAL
// ============================================================
// Cache items from last loadContent to avoid extra API call
var _itemsCache = [];

function viewDetail(docId, showReview) {
    document.getElementById('detailTitle').textContent = 'Carregando...';
    document.getElementById('detailBody').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    document.getElementById('detailActions').innerHTML = '<button class="btn btn-outline" onclick="closeDetailModal()">Fechar</button>';
    document.getElementById('detailModal').classList.add('show');
    
    // Try cache first
    var item = null;
    _itemsCache.forEach(function(i) { if ((i.id || i.doc_id) === docId) item = i; });
    
    if (item) {
        renderDetailModal(item, showReview);
    } else {
        fetch(apiUrl('/api/kb/content/list?limit=200'))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            (data.items || []).forEach(function(i) {
                if ((i.id || i.doc_id) === docId) item = i;
            });
            if (item) {
                renderDetailModal(item, showReview);
            } else {
                document.getElementById('detailTitle').textContent = 'Documento nao encontrado';
                document.getElementById('detailBody').innerHTML = '<p>ID: ' + escapeHtml(docId) + '</p>';
            }
        })
        .catch(function(err) {
            document.getElementById('detailTitle').textContent = 'Erro';
            document.getElementById('detailBody').innerHTML = '<p>' + escapeHtml(err.message) + '</p>';
        });
    }
}

function renderDetailModal(item, showReview) {
    var docId = item.id || item.doc_id || '';
    var reviewStatus = item.review_status || '';
    
    // Extract juridical info
    var tribunal = '', caseName = '', year = '', uf = '', confidence = '', citation = '';
    if (item.detected) {
        var det = item.detected;
        tribunal = det.tribunal || det.tribunal_family || '';
        caseName = det.case_number_primary || '';
        year = det.year || '';
        uf = det.uf || '';
        confidence = det.confidence ? (det.confidence * 100).toFixed(0) + '%' : '';
        citation = det.citation || '';
    }
    
    // Modal title: juridical, not blob path
    var title = '';
    if (tribunal && caseName) title = tribunal + ' - ' + caseName;
    else if (citation) title = citation;
    else if (tribunal && year) title = tribunal + ' ' + year;
    else title = item.title || 'Jurisprudencia';
    document.getElementById('detailTitle').textContent = title;
    
    // --- Build body ---
    var html = '';
    
    // Juridical info grid (2 columns)
    html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px;">';
    html += '<div class="det-item"><div class="det-label">Status</div><div style="margin-top:6px;">' + statusBadge(reviewStatus) + '</div></div>';
    html += '<div class="det-item"><div class="det-label">Tribunal</div><div class="det-value">' + (tribunal || 'N/A') + '</div></div>';
    if (caseName) html += '<div class="det-item"><div class="det-label">Caso / Numero</div><div class="det-value">' + escapeHtml(caseName) + '</div></div>';
    if (year) html += '<div class="det-item"><div class="det-label">Ano</div><div class="det-value">' + year + '</div></div>';
    if (uf) html += '<div class="det-item"><div class="det-label">UF</div><div class="det-value">' + uf + '</div></div>';
    if (confidence) html += '<div class="det-item"><div class="det-label">Confianca Deteccao</div><div class="det-value">' + confidence + '</div></div>';
    if (citation) html += '<div class="det-item" style="grid-column:1/-1;"><div class="det-label">Citacao Completa</div><div style="color:var(--text-secondary);margin-top:4px;">' + escapeHtml(citation) + '</div></div>';
    html += '</div>';
    
    // Text preview
    var fullText = item.content || item.text_preview || item.text || '';
    if (fullText) {
        html += '<div class="det-item" style="margin-bottom:16px;"><div class="det-label">Texto</div>';
        html += '<div style="color:var(--text-secondary);margin-top:6px;line-height:1.7;max-height:300px;overflow-y:auto;font-size: 24px;white-space:pre-wrap;">' + escapeHtml(fullText) + '</div></div>';
    }
    
    // Reject reason (if any)
    if (item.reject_reason) {
        html += '<div class="det-item" style="border:1px solid #fca5a5;margin-bottom:16px;"><div class="det-label">Motivo Rejeicao</div>';
        html += '<div style="color:var(--red-500);margin-top:4px;">' + escapeHtml(item.reject_reason) + '</div></div>';
    }
    
    // ID (small, at bottom)
    html += '<div style="font-size: 20px;color:var(--text-muted);margin-bottom:8px;">ID: ' + escapeHtml(docId) + '</div>';
    
    // --- REVIEW FORM (only for PENDING + showReview) ---
    if (showReview && reviewStatus === 'PENDING_REVIEW') {
        html += '<div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">';
        html += '<h4 style="font-family:DM Serif Display,serif; font-size: 32px; color:var(--gold-600); margin-bottom:14px;">Revisao Juridica</h4>';
        
        // Citability checkboxes
        html += '<div style="margin-bottom:16px;">';
        html += '<div class="det-label" style="margin-bottom:8px;">Citabilidade (obrigatorio)</div>';
        html += '<div style="display:flex;flex-direction:column;gap:6px;">';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size: 25px;"><input type="checkbox" id="rv_tribunal_ok" style="width:18px;height:18px;accent-color:var(--gold-500);"> Tribunal identificado corretamente</label>';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size: 25px;"><input type="checkbox" id="rv_case_ok" style="width:18px;height:18px;accent-color:var(--gold-500);"> Numero do caso / acordao presente</label>';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size: 25px;"><input type="checkbox" id="rv_decisory_ok" style="width:18px;height:18px;accent-color:var(--gold-500);"> Trecho decisorio identificavel</label>';
        html += '</div></div>';
        
        // Completeness
        html += '<div style="margin-bottom:16px;">';
        html += '<div class="det-label" style="margin-bottom:8px;">Completude</div>';
        html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size: 25px;margin-bottom:8px;"><input type="checkbox" id="rv_needs_full" style="width:18px;height:18px;accent-color:var(--gold-500);"> Precisa inteiro teor (nao indexar agora)</label>';
        html += '<input type="text" id="rv_completeness_notes" placeholder="Notas sobre completude (opcional)" style="font-size: 24px;padding:8px 12px;">';
        html += '</div>';
        
        // Classification - direction of decision
        html += '<div style="margin-bottom:8px;">';
        html += '<div class="det-label" style="margin-bottom:8px;">Direcao da Decisao</div>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';
        html += '<div><label style="font-size: 20px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:4px;">Effect</label>';
        html += '<select id="rv_effect" style="font-size: 24px;padding:8px 12px;">';
        html += '<option value="CONDICIONAL" selected>CONDICIONAL (padrao/duvida)</option>';
        html += '<option value="FLEXIBILIZA">FLEXIBILIZA</option>';
        html += '<option value="RIGORIZA">RIGORIZA</option>';
        html += '</select></div>';
        html += '<div><label style="font-size: 20px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:4px;">Justificativa (opcional)</label>';
        html += '<input type="text" id="rv_rationale" placeholder="Breve motivo" style="font-size: 24px;padding:8px 12px;"></div>';
        html += '</div></div>';
        
        html += '</div>'; // close review section
    }
    
    document.getElementById('detailBody').innerHTML = html;
    
    // --- Dynamic actions (LEFT aligned) ---
    var actHtml = '';
    if (showReview && reviewStatus === 'PENDING_REVIEW') {
        actHtml += '<button class="btn btn-green" onclick="submitApproveWithReview(\'' + docId + '\')">Aprovar com Revisao</button>';
        actHtml += '<button class="btn btn-red" onclick="closeDetailModal();openRejectModal(\'' + docId + '\')">Rejeitar</button>';
    }
    actHtml += '<button class="btn btn-outline" onclick="closeDetailModal()">Fechar</button>';
    document.getElementById('detailActions').innerHTML = actHtml;
}

// Submit approval with review payload
function submitApproveWithReview(docId) {
    var tribunalOk = document.getElementById('rv_tribunal_ok').checked;
    var caseOk = document.getElementById('rv_case_ok').checked;
    var decisoryOk = document.getElementById('rv_decisory_ok').checked;
    var needsFull = document.getElementById('rv_needs_full').checked;
    var completenessNotes = document.getElementById('rv_completeness_notes').value.trim();
    var effect = document.getElementById('rv_effect').value;
    var rationale = document.getElementById('rv_rationale').value.trim();
    
    // Validation
    if (!tribunalOk || !caseOk || !decisoryOk) {
        showToast('Marque os 3 checkboxes de citabilidade para aprovar. Se nao atende, rejeite.', 'error');
        return;
    }
    
    var payload = {
        review: {
            reviewer: 'paulo@govy.com.br',
            citability: {
                tribunal_ok: tribunalOk,
                case_number_ok: caseOk,
                decisory_excerpt_ok: decisoryOk
            },
            completeness: {
                needs_full_text: needsFull,
                notes: completenessNotes
            },
            classification: {
                effect: effect || 'CONDICIONAL',
                effect_confidence: (effect && effect !== 'CONDICIONAL') ? 0.7 : 0.0,
                effect_rationale: rationale
            }
        }
    };
    
    closeDetailModal();
    showToast('Aprovando com revisao...', 'info');
    
    fetch(apiUrl('/api/kb/content/' + docId + '/approve'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(function(r) {
        var httpOk = r.ok;
        return r.json().then(function(data) { return { httpOk: httpOk, data: data }; });
    })
    .then(function(result) {
        var data = result.data;
        console.log('Approve response:', JSON.stringify(data));
        var isSuccess = data.status === 'success' || data.status === 'approved' || data.status === 'ok' || (result.httpOk && !data.error);
        if (isSuccess) {
            var extra = '';
            if (data.kb_upsert) extra = ' (indexed: ' + (data.kb_upsert.indexed || 0) + ')';
            showToast('Documento aprovado!' + extra, 'success');
            loadContent();
            loadStats();
        } else {
            showToast('Erro ao aprovar: ' + (data.error || data.message || data.detail || JSON.stringify(data)), 'error');
        }
    })
    .catch(function(err) {
        showToast('Erro de conexao: ' + err.message, 'error');
    });
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.remove('show');
}

// ============================================================
// SEARCH KB
// ============================================================
function searchKB() {
    var query = document.getElementById('searchQuery').value.trim();
    if (!query) {
        showToast('Informe um termo de busca', 'error');
        return;
    }
    
    var top = document.getElementById('searchTop').value;
    var container = document.getElementById('searchResults');
    container.innerHTML = '<div class="card"><div class="loading"><div class="spinner"></div><br>Buscando...</div></div>';
    
    fetch(apiUrl('/api/kb/search'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: query, top: parseInt(top) })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.status === 'error') {
            container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-text">Erro: ' + escapeHtml(data.error) + '</div></div></div>';
            return;
        }
        
        var results = data.results || [];
        if (results.length === 0) {
            container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-text">Nenhum resultado para "' + escapeHtml(query) + '"</div></div></div>';
            return;
        }
        
        var html = '<div class="card"><h2>Resultados (' + results.length + ')</h2>';
        
        // Fallback info
        if (data.fallback_info) {
            var fi = data.fallback_info;
            html += '<div style="margin-bottom:16px;padding:10px;background:#f3f4f6;border-radius:8px;font-size: 22px;color:var(--text-muted);">';
            html += 'Modo: ' + JSON.stringify(fi.final_mode || {}) + ' | Tentativas: ' + (fi.mode_attempts ? fi.mode_attempts.length : '?');
            html += '</div>';
        }
        
        results.forEach(function(r, i) {
            html += '<div style="padding:16px;border-bottom:1px solid #f0f1f3;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
            html += '<strong style="color:var(--gold-500);">#' + (i+1) + ' ' + escapeHtml(r.title || r.citation || 'N/A') + '</strong>';
            html += '<span style="font-size: 22px;color:var(--text-muted);">Score: ' + (r['@search.reranker_score'] || r['@search.score'] || 'N/A') + '</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:8px;margin-bottom:8px;">';
            html += sourceBadge(r.tribunal || r.source || '');
            html += '<span class="badge" style="background:#f3f4f6;color:var(--text-muted);">' + (r.doc_type || 'N/A') + '</span>';
            if (r.procedural_stage) html += '<span class="badge" style="background:#dbeafe;color:var(--blue-500);">' + r.procedural_stage + '</span>';
            html += '</div>';
            html += '<div style="font-size: 24px;line-height:1.6;color:var(--text-secondary);">' + escapeHtml((r.content || '').substring(0, 400)) + '</div>';
            html += '</div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    })
    .catch(function(err) {
        container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-text">Erro: ' + escapeHtml(err.message) + '</div></div></div>';
    });
}

// ============================================================
// KEYBOARD NAVIGATION
// ============================================================
document.addEventListener('keydown', function(e) {
    // Escape: close modals
    if (e.key === 'Escape') {
        if (document.getElementById('detailModal').classList.contains('show')) { closeDetailModal(); return; }
        if (document.getElementById('rejectModal').classList.contains('show')) { closeRejectModal(); return; }
    }
    // Alt+1/2/3: switch tabs
    if (e.altKey && !e.ctrlKey && !e.metaKey) {
        if (e.key === '1') { e.preventDefault(); switchTab('paste'); }
        if (e.key === '2') { e.preventDefault(); switchTab('manage'); }
        if (e.key === '3') { e.preventDefault(); switchTab('search'); }
    }
});

// ============================================================
// INIT
// ============================================================
(function() {
    fetch(apiUrl('/api/kb/content/list?limit=1'))
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.status === 'success') {
            document.getElementById('connStatus').textContent = 'Conectado (' + (data.total || 0) + ' docs)';
        }
    })
    .catch(function() {
        document.getElementById('connStatus').textContent = 'Desconectado';
        var dot = document.querySelector('.status-dot');
        if (dot) dot.style.background = 'var(--red-500)';
    });
})();
</script>
</body>
</html>
