import sys
import os
import json
import azure.functions as func

ROOT = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, ROOT)

app = func.FunctionApp()

@app.function_name(name="ping")
@app.route(route="ping", methods=["GET"], auth_level=func.AuthLevel.ANONYMOUS)
def ping(req: func.HttpRequest) -> func.HttpResponse:
    return func.HttpResponse("pong", status_code=200)

@app.function_name(name="extract_params")
@app.route(route="extract_params", methods=["POST"], auth_level=func.AuthLevel.FUNCTION)
def extract_params(req: func.HttpRequest) -> func.HttpResponse:
    try:
        body = req.get_json()
        blob_name = body.get("blob_name") if body else None
    except:
        blob_name = None
    
    if not blob_name:
        return func.HttpResponse(
            json.dumps({"error": "blob_name required"}),
            status_code=400,
            mimetype="application/json"
        )
    
    return func.HttpResponse(
        json.dumps({"status": "stub_ok", "blob_name": blob_name}),
        status_code=200,
        mimetype="application/json"
    )

@app.function_name(name="parse_layout")
@app.route(route="parse_layout", methods=["POST"], auth_level=func.AuthLevel.FUNCTION)
def parse_layout(req: func.HttpRequest) -> func.HttpResponse:
    return func.HttpResponse(
        json.dumps({"status": "stub_ok", "function": "parse_layout"}),
        status_code=200,
        mimetype="application/json"
    )

@app.function_name(name="upload_edital")
@app.route(route="upload_edital", methods=["POST"], auth_level=func.AuthLevel.FUNCTION)
def upload_edital(req: func.HttpRequest) -> func.HttpResponse:
    return func.HttpResponse(
        json.dumps({"status": "stub_ok", "function": "upload_edital"}),
        status_code=200,
        mimetype="application/json"
    )
